<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VK Market Parser - –ü–∞—Ä—Å–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f0f2f5;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #4a76a8 0%, #1e3c72 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .info-box {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1565c0;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .info-box h3 {
            margin-bottom: 15px;
        }

        .info-box ol {
            margin-left: 20px;
        }

        .info-box li {
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #4a76a8;
            box-shadow: 0 0 0 3px rgba(74, 118, 168, 0.1);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn {
            display: inline-block;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #4a76a8 0%, #1e3c72 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 118, 168, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .progress {
            display: none;
            margin-top: 30px;
        }

        .progress-bar {
            background: #e1e8ed;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4a76a8 0%, #1e3c72 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .status {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .results {
            display: none;
            margin-top: 30px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4a76a8 0%, #1e3c72 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .help-text {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .preview-table {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .code-block {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }

        a {
            color: #4a76a8;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .token-input {
            font-family: monospace;
            font-size: 14px;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VK Market Parser</h1>
            <p>–ü–∞—Ä—Å–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –≥—Ä—É–ø–ø –í–ö–æ–Ω—Ç–∞–∫—Ç–µ —Å —ç–∫—Å–ø–æ—Ä—Ç–æ–º –≤ CSV</p>
        </div>

        <div class="card">
            <div class="info-box">
                <h3>üìã –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å Access Token:</h3>
                <ol>
                    <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ: <a href="https://vk.cc/c8P5N8" target="_blank">–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω</a></li>
                    <li>–ù–∞–∂–º–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å"</li>
                    <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –∏–∑ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ (–ø–æ—Å–ª–µ access_token=)</li>
                    <li>–í—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ –ø–æ–ª–µ –Ω–∏–∂–µ</li>
                </ol>
                <p style="margin-top: 15px;"><strong>–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±:</strong> <a href="https://vkhost.github.io/" target="_blank">VKHost Token</a></p>
            </div>

            <div class="form-group">
                <label for="accessToken">Access Token VK API</label>
                <input type="text" id="accessToken" class="token-input" placeholder="vk1.a.XXXXXXXXX...">
                <div class="help-text">–¢–æ–∫–µ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "vk1.a." –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∫–æ–ª–æ 85 —Å–∏–º–≤–æ–ª–æ–≤</div>
            </div>

            <div class="form-group">
                <label for="groupUrls">–°—Å—ã–ª–∫–∏ –Ω–∞ –≥—Ä—É–ø–ø—ã –í–ö</label>
                <textarea id="groupUrls" placeholder="https://vk.com/apple&#10;https://vk.com/samsung&#10;https://vk.com/xiaomi&#10;..."></textarea>
                <div class="help-text">
                    –ö–∞–∂–¥–∞—è —Å—Å—ã–ª–∫–∞ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏. –ü—Ä–∏–º–µ—Ä—ã —Ñ–æ—Ä–º–∞—Ç–æ–≤:<br>
                    ‚Ä¢ vk.com/apple<br>
                    ‚Ä¢ vk.com/club123456<br>
                    ‚Ä¢ vk.com/public123456
                </div>
            </div>

            <div class="form-group">
                <label for="maxItems">–ú–∞–∫—Å–∏–º—É–º —Ç–æ–≤–∞—Ä–æ–≤ —Å –≥—Ä—É–ø–ø—ã</label>
                <input type="text" id="maxItems" value="100" placeholder="100">
                <div class="help-text">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–µ –±–æ–ª–µ–µ 500 –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–∞–±–æ—Ç—ã</div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="includePhotos" checked>
                <label for="includePhotos">–í–∫–ª—é—á–∏—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ</label>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="includeDescription" checked>
                <label for="includeDescription">–í–∫–ª—é—á–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤</label>
            </div>

            <button class="btn" onclick="startParsing()" id="parseBtn">–ù–∞—á–∞—Ç—å –ø–∞—Ä—Å–∏–Ω–≥</button>
        </div>

        <div class="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="status" id="status">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø–∞—Ä—Å–∏–Ω–≥—É...</div>
        </div>

        <div class="error" id="error"></div>
        <div class="success-message" id="success"></div>

        <div class="results">
            <div class="card">
                <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞</h2>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalItems">0</div>
                        <div>–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalGroups">0</div>
                        <div>–ì—Ä—É–ø–ø –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgPrice">0</div>
                        <div>–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</div>
                    </div>
                </div>

                <button class="btn" onclick="downloadCSV()">üíæ –°–∫–∞—á–∞—Ç—å CSV</button>
                <button class="btn btn-secondary" onclick="copyToClipboard()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä</button>

                <div class="preview-table">
                    <h3 style="margin: 20px 0 10px;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö (–ø–µ—Ä–≤—ã–µ 10 —Ç–æ–≤–∞—Ä–æ–≤)</h3>
                    <table id="previewTable">
                        <thead>
                            <tr id="tableHeader"></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let parsedData = [];
        let accessToken = '';

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ
        document.getElementById('accessToken').addEventListener('input', function(e) {
            const token = e.target.value.trim();
            if (token.startsWith('vk1.a.') && token.length > 80) {
                showSuccess('–¢–æ–∫–µ–Ω –≤—ã–≥–ª—è–¥–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úÖ');
            }
        });

        async function startParsing() {
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
            accessToken = document.getElementById('accessToken').value.trim();
            const groupUrls = document.getElementById('groupUrls').value.trim().split('\n').filter(url => url);
            const maxItems = parseInt(document.getElementById('maxItems').value) || 100;
            const includePhotos = document.getElementById('includePhotos').checked;
            const includeDescription = document.getElementById('includeDescription').checked;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!accessToken) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ Access Token');
                return;
            }

            if (!accessToken.startsWith('vk1.a.')) {
                showError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞. –¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å "vk1.a."');
                return;
            }

            if (groupUrls.length === 0) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Å—ã–ª–∫—É –Ω–∞ –≥—Ä—É–ø–ø—É');
                return;
            }

            // –°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö
            parsedData = [];
            hideError();
            hideSuccess();
            showProgress();
            hideResults();
            document.getElementById('parseBtn').disabled = true;

            let successGroups = 0;
            let failedGroups = [];

            // –ü–∞—Ä—Å–∏–Ω–≥ –≥—Ä—É–ø–ø
            for (let i = 0; i < groupUrls.length; i++) {
                updateProgress((i / groupUrls.length) * 100, `–û–±—Ä–∞–±–æ—Ç–∫–∞ –≥—Ä—É–ø–ø—ã ${i + 1} –∏–∑ ${groupUrls.length}...`);
                
                try {
                    const groupId = extractGroupId(groupUrls[i]);
                    if (groupId) {
                        await parseGroup(groupId, maxItems, includePhotos, includeDescription);
                        successGroups++;
                    } else {
                        failedGroups.push(groupUrls[i]);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –≥—Ä—É–ø–ø—ã:', error);
                    failedGroups.push(groupUrls[i]);
                }
                
                // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                await delay(350);
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            updateProgress(100, '–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω!');
            
            setTimeout(() => {
                hideProgress();
                document.getElementById('parseBtn').disabled = false;
                
                if (parsedData.length > 0) {
                    showResults();
                    if (failedGroups.length > 0) {
                        showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å ${failedGroups.length} –≥—Ä—É–ø–ø: ${failedGroups.join(', ')}`);
                    }
                } else {
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≥—Ä—É–ø–ø—ã.');
                }
            }, 1000);
        }

        function extractGroupId(url) {
            // –û—á–∏—â–∞–µ–º URL
            url = url.trim().replace(/https?:\/\//i, '').replace(/\/$/, '');
            
            const patterns = [
                /vk\.com\/club(\d+)/,
                /vk\.com\/public(\d+)/,
                /vk\.com\/([a-zA-Z0-9_]+)$/
            ];

            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    return match[1];
                }
            }

            // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ ID –∏–ª–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è
            if (/^[a-zA-Z0-9_]+$/.test(url)) {
                return url;
            }

            return null;
        }

        async function parseGroup(groupId, maxItems, includePhotos, includeDescription) {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–ø–ø–µ
                let ownerId = groupId;
                
                // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —á–∏—Å–ª–æ–≤–æ–π ID, –ø–æ–ª—É—á–∞–µ–º –µ–≥–æ —á–µ—Ä–µ–∑ API
                if (isNaN(groupId)) {
                    const groupInfo = await vkApi('utils.resolveScreenName', {
                        screen_name: groupId
                    });
                    
                    if (groupInfo.response && groupInfo.response.type === 'group') {
                        ownerId = -groupInfo.response.object_id;
                    } else {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥—Ä—É–ø–ø—É');
                    }
                } else {
                    ownerId = -Math.abs(parseInt(groupId));
                }

                // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–≤–∞—Ä—ã
                let offset = 0;
                const count = 200; // –ú–∞–∫—Å–∏–º—É–º –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
                let totalParsed = 0;

                while (totalParsed < maxItems) {
                    const items = await vkApi('market.get', {
                        owner_id: ownerId,
                        count: Math.min(count, maxItems - totalParsed),
                        offset: offset,
                        extended: 1
                    });

                    if (!items.response || !items.response.items || items.response.items.length === 0) {
                        break;
                    }

                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã
                    for (const item of items.response.items) {
                        const product = {
                            'ID —Ç–æ–≤–∞—Ä–∞': item.id,
                            '–ù–∞–∑–≤–∞–Ω–∏–µ': item.title || '',
                            '–¶–µ–Ω–∞': item.price ? `${(item.price.amount / 100).toFixed(2)}` : '0',
                            '–í–∞–ª—é—Ç–∞': item.price ? item.price.currency.name : 'RUB',
                            '–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞': item.price && item.price.old_amount ? `${(item.price.old_amount / 100).toFixed(2)}` : '',
                            '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': item.category ? item.category.name : '',
                            '–ù–∞–ª–∏—á–∏–µ': item.availability === 0 ? '–í –Ω–∞–ª–∏—á–∏–∏' : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏',
                            '–°—Å—ã–ª–∫–∞': `https://vk.com/market${ownerId}?w=product${ownerId}_${item.id}`
                        };

                        if (includeDescription) {
                            product['–û–ø–∏—Å–∞–Ω–∏–µ'] = (item.description || '').replace(/\n/g, ' ').substring(0, 500);
                        }

                        if (includePhotos && item.thumb_photo) {
                            product['–§–æ—Ç–æ'] = item.thumb_photo;
                        }

                        parsedData.push(product);
                        totalParsed++;
                    }

                    offset += count;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    const groupProgress = (totalParsed / maxItems) * 100;
                    updateProgress(groupProgress, `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${totalParsed} —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –≥—Ä—É–ø–ø—ã...`);
                    
                    await delay(350); // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ VK API - 3 –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–µ–∫—É–Ω–¥—É
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –≥—Ä—É–ø–ø—ã:', error);
                throw error;
            }
        }

        function vkApi(method, params) {
            return new Promise((resolve, reject) => {
                const callbackName = 'vkCallback' + Math.random().toString(36).substr(2, 9);
                const url = `https://api.vk.com/method/${method}`;
                const queryParams = new URLSearchParams({
                    ...params,
                    access_token: accessToken,
                    v: '5.131',
                    callback: callbackName
                });

                // –°–æ–∑–¥–∞–µ–º callback —Ñ—É–Ω–∫—Ü–∏—é
                window[callbackName] = function(data) {
                    // –£–¥–∞–ª—è–µ–º callback –∏ script
                    delete window[callbackName];
                    document.body.removeChild(script);

                    if (data.error) {
                        console.error('VK API Error:', data.error);
                        reject(new Error(data.error.error_msg || '–û—à–∏–±–∫–∞ VK API'));
                    } else {
                        resolve(data);
                    }
                };

                // –°–æ–∑–¥–∞–µ–º script —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è JSONP
                const script = document.createElement('script');
                script.src = `${url}?${queryParams}`;
                script.onerror = () => {
                    delete window[callbackName];
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                    reject(new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞'));
                };

                document.body.appendChild(script);
            });
        }

        function showProgress() {
            document.querySelector('.progress').style.display = 'block';
        }

        function hideProgress() {
            document.querySelector('.progress').style.display = 'none';
        }

        function updateProgress(percent, status) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressFill').textContent = Math.round(percent) + '%';
            document.getElementById('status').textContent = status;
        }

        function showResults() {
            document.getElementById('totalItems').textContent = parsedData.length;
            
            // –ü–æ–¥—Å—á–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≥—Ä—É–ø–ø
            const uniqueGroups = new Set(parsedData.map(item => {
                const match = item['–°—Å—ã–ª–∫–∞'].match(/market(-?\d+)/);
                return match ? match[1] : null;
            })).size;
            document.getElementById('totalGroups').textContent = uniqueGroups;
            
            // –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞
            const prices = parsedData.map(item => parseFloat(item['–¶–µ–Ω–∞'])).filter(price => price > 0);
            const avgPrice = prices.length > 0 ? (prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(2) : 0;
            document.getElementById('avgPrice').textContent = avgPrice + ' ‚ÇΩ';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–∞–±–ª–∏—Ü—ã
            if (parsedData.length > 0) {
                const headers = Object.keys(parsedData[0]);
                const headerRow = document.getElementById('tableHeader');
                headerRow.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
                
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = parsedData.slice(0, 10).map(item => 
                    `<tr>${headers.map(h => `<td>${item[h]}</td>`).join('')}</tr>`
                ).join('');
            }
            
            document.querySelector('.results').style.display = 'block';
            showSuccess(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${parsedData.length} —Ç–æ–≤–∞—Ä–æ–≤!`);
        }

        function hideResults() {
            document.querySelector('.results').style.display = 'none';
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            errorEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showSuccess(message) {
            const successEl = document.getElementById('success');
            successEl.textContent = message;
            successEl.style.display = 'block';
        }

        function hideSuccess() {
            document.getElementById('success').style.display = 'none';
        }

        function generateCSV() {
            if (parsedData.length === 0) return '';

            const headers = Object.keys(parsedData[0]);
            const csvHeaders = headers.join(';');
            
            const csvRows = parsedData.map(item => 
                headers.map(header => {
                    const value = item[header] || '';
                    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –∏ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –∫–∞–≤—ã—á–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
                    if (value.toString().includes(';') || value.toString().includes('"') || value.toString().includes('\n')) {
                        return `"${value.toString().replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(';')
            );

            return csvHeaders + '\n' + csvRows.join('\n');
        }

        function downloadCSV() {
            const csv = generateCSV();
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `vk_market_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function copyToClipboard() {
            const csv = generateCSV();
            navigator.clipboard.writeText(csv).then(() => {
                showSuccess('–î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞! üìã');
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏:', err);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ');
            });
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
